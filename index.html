<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ianlrsn links</title>
    <meta name="description" content="Watch and follow" />
    <meta property="og:title" content="ianlrsn" />
    <meta property="og:description" content="Watch and follow" />
    <meta property="og:image" content="https://ianlrsn.com/assets/og-image.jpg" />
    <meta property="og:url" content="https://ianlrsn.com" />
    <meta property="og:site_name" content="ianlrsn" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="ianlrsn" />
    <meta name="twitter:description" content="Watch and follow" />
    <meta name="twitter:image" content="https://ianlrsn.com/assets/og-image.jpg" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="stage" aria-hidden="true"></div>
    <main class="page">
      <section class="card">
        <header class="hero">
          <div class="avatar" role="img" aria-label="Ian">
            <div class="avatar-media" aria-hidden="true"></div>
            <div class="avatar-word" aria-hidden="true">ian</div>
          </div>
          <p class="handle">@ianlrsn</p>
          <div class="socials" aria-label="social links">
            <a class="social" href="https://www.twitch.tv/ianlrsn" aria-label="Twitch">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
  <path d="M3.857 0 1 2.857v10.286h3.429V16l2.857-2.857H9.57L14.714 8V0zm9.714 7.429-2.285 2.285H9l-2 2v-2H4.429V1.143h9.142z"/>
  <path d="M11.857 3.143h-1.143V6.57h1.143zm-3.143 0H7.571V6.57h1.143z"/>
</svg>
            </a>
            <a class="social" href="https://tiktok.com/@ianlrsn" aria-label="TikTok">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
  <path d="M9 0h1.98c.144.715.54 1.617 1.235 2.512C12.895 3.389 13.797 4 15 4v2c-1.753 0-3.07-.814-4-1.829V11a5 5 0 1 1-5-5v2a3 3 0 1 0 3 3z"/>
</svg>
            </a>
            <a class="social" href="https://discord.gg/dfxz4FyDnE" aria-label="Discord">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
  <path d="M13.545 2.907a13.2 13.2 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.2 12.2 0 0 0-3.658 0 8 8 0 0 0-.412-.833.05.05 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.04.04 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032q.003.022.021.037a13.3 13.3 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019q.463-.63.818-1.329a.05.05 0 0 0-.01-.059l-.018-.011a9 9 0 0 1-1.248-.595.05.05 0 0 1-.02-.066l.015-.019q.127-.095.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.05.05 0 0 1 .053.007q.121.1.248.195a.05.05 0 0 1-.004.085 8 8 0 0 1-1.249.594.05.05 0 0 0-.03.03.05.05 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.2 13.2 0 0 0 4.001-2.02.05.05 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.03.03 0 0 0-.02-.019m-8.198 7.307c-.789 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612m5.316 0c-.788 0-1.438-.724-1.438-1.612s.637-1.613 1.438-1.613c.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612"/>
</svg>
            </a>
            <a class="social" href="https://www.instagram.com/ianlrsn" aria-label="Instagram">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
  <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.9 3.9 0 0 0-1.417.923A3.9 3.9 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.9 3.9 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.9 3.9 0 0 0-.923-1.417A3.9 3.9 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599s.453.546.598.92c.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.5 2.5 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.5 2.5 0 0 1-.92-.598 2.5 2.5 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233s.008-2.388.046-3.231c.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92s.546-.453.92-.598c.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92m-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217m0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"/>
</svg>
            </a>
            <a class="social" href="https://youtube.com/@ianlrsn?si=PY8eBxGL5ZDL8J9h" aria-label="YouTube">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true">
  <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.01 2.01 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.01 2.01 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31 31 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.01 2.01 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A100 100 0 0 1 7.858 2zM6.4 5.209v4.818l4.157-2.408z"/>
</svg>
            </a>
            <!-- Cash App icon removed; restore when donations link is ready. -->
          </div>
        </header>
        <section class="links">
          <a class="link" href="https://www.twitch.tv/ianlrsn" data-twitch>
            <span class="thumb">
              <img src="icons/twitch.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">Twitch @ianlrsn</span>
            <span class="dots">&#8942;</span>
            <span class="twitch-player" aria-hidden="true"></span>
          </a>
          <a class="link" href="https://tiktok.com/@ianlrsn">
            <span class="thumb">
              <img src="icons/tiktok.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">TikTok @ianlrsn</span>
            <span class="dots">&#8942;</span>
          </a>
          <a class="link" href="https://discord.gg/dfxz4FyDnE">
            <span class="thumb">
              <img src="icons/discord.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">Discord @ianlrsn</span>
            <span class="dots">&#8942;</span>
          </a>
          <a class="link" href="https://www.instagram.com/ianlrsn">
            <span class="thumb">
              <img src="icons/instagram.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">Instagram @ianlrsn</span>
            <span class="dots">&#8942;</span>
          </a>
          <a class="link" href="https://youtube.com/@ianlrsn?si=PY8eBxGL5ZDL8J9h">
            <span class="thumb">
              <img src="icons/youtube.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">YouTube @ianlrsn</span>
            <span class="dots">&#8942;</span>
          </a>
          <a class="link" href="#">
            <span class="thumb nintendo">
              <img src="icons/nintendo.svg" alt="" aria-hidden="true" />
            </span>
            <span class="label">Nintendo Â· SW-6525-1278-1508</span>
            <span class="dots">&#8942;</span>
          </a>
          <!-- Cash App tile removed; restore when donations link is ready. -->
        </section>
      </section>
    </main>
    <script>
      const CYCLE_MS = 500;
      const CUT_FLASH_MS = 110;
      const stage = document.querySelector(".stage");
      const card = document.querySelector(".card");
      const avatarMedia = document.querySelector(".avatar-media");
      const avatarWord = document.querySelector(".avatar-word");
      let index = 0;
      let cycleTimer = null;
      const sequence = [
        { type: "image", bg: "#8acd00" },
        { type: "word", text: "live", bg: "#2750ff", color: "#ff2b2b" },
        { type: "word", text: "right now", bg: "#ff2b2b", color: "#b7ff00" },
        { type: "word", text: "twitch", bg: "#9146ff", color: "#ffffff" },
        {
          type: "word",
          text: "tiktok",
          bg: "#000000",
          color: "#ffffff",
        },
      ];

      const stepCycle = () => {
        const step = sequence[index % sequence.length];
        if (stage) stage.style.setProperty("--stage-color", "#000000");
        document.documentElement.style.setProperty("--live-text-color", "#ffffff");
        document.documentElement.style.setProperty("--live-icon-filter", "brightness(0) invert(1)");
        if (card) card.classList.add("live-mode");
        if (avatarMedia && avatarWord) {
          avatarMedia.classList.remove("show");
          avatarWord.classList.remove("show");
        }

        const bg = step.bg || "#8acd00";
        const textColor = step.color || "#000000";
        if (stage) stage.style.setProperty("--stage-color", bg);
        document.documentElement.style.setProperty("--live-bg-color", bg);
        document.documentElement.style.setProperty("--live-text-color", textColor);
        document.documentElement.style.setProperty(
          "--live-icon-filter",
          textColor === "#ffffff" ? "brightness(0) invert(1)" : "none"
        );
        if (avatarMedia && avatarWord) {
          avatarWord.className = "avatar-word";
          avatarWord.style.color = textColor;
          avatarWord.style.background = bg;
          if (step.type === "image") {
            avatarMedia.classList.add("show");
          } else {
            avatarWord.textContent = step.text;
            const textLength = step.text?.length || 0;
            const fontSize = textLength >= 9 ? "15px" : textLength >= 7 ? "17px" : "20px";
            avatarWord.style.fontSize = fontSize;
            avatarWord.classList.add("show");
          }
        }

        index += 1;
      };

      const startCycle = () => {
        if (cycleTimer) return;
        if (card) card.classList.add("live-mode");
        stepCycle();
        cycleTimer = setInterval(stepCycle, CYCLE_MS);
      };

      const stopCycle = () => {
        if (cycleTimer) {
          clearInterval(cycleTimer);
          cycleTimer = null;
        }
        if (stage) stage.style.setProperty("--stage-color", "#8acd00");
        if (card) card.classList.remove("live-mode");
        if (avatarMedia && avatarWord) {
          avatarMedia.classList.add("show");
          avatarWord.className = "avatar-word";
          avatarWord.classList.remove("show");
          avatarWord.textContent = "";
          avatarWord.style.color = "#000";
          avatarWord.style.background = "var(--hot-red)";
        }
        document.documentElement.style.setProperty("--live-bg-color", "#8acd00");
        document.documentElement.style.setProperty("--live-text-color", "#d6ff2d");
        document.documentElement.style.setProperty("--live-icon-filter", "none");
      };

      const twitchRow = document.querySelector("[data-twitch]");
      const twitchPlayer = twitchRow?.querySelector(".twitch-player");
      const SESSION_ID_STORAGE_KEY = "ianlrsn_session_id";
      const USER_ID_STORAGE_KEY = "ianlrsn_user_id";
      const UUID_RE =
        /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
      const CACHE_TTL_MS = 60000;
      const EARLY_CACHE_THRESHOLD_MS = 2000;
      const EXTRA_OFFSET_MIN_MS = 2000;
      const EXTRA_OFFSET_MAX_MS = 10000;
      let liveCheckTimer;
      let extraOffsetMs = 0;
      let extraOffsetApplied = false;
      let activeSessionId = null;
      let activeUserId = null;
      const params = new URLSearchParams(window.location.search);
      const testLive = params.get("test_live") === "1";
      const forceLive = params.get("force_live") === "1";
      if (forceLive && card) card.classList.add("live-mode");

      const isUuid = (value) => UUID_RE.test(String(value || ""));

      const clearSessionId = () => {
        activeSessionId = null;
        sessionStorage.removeItem(SESSION_ID_STORAGE_KEY);
      };

      const bootstrapIdentity = async () => {
        const existingUserId = localStorage.getItem(USER_ID_STORAGE_KEY);
        const body = {};
        if (isUuid(existingUserId)) {
          body.user_id = existingUserId;
        }

        const response = await fetch("/api/turnstile", {
          method: "POST",
          cache: "no-store",
          headers: {
            "content-type": "application/json",
          },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          throw new Error("turnstile bootstrap failed");
        }

        const data = await response.json();
        if (!isUuid(data?.session_id) || !isUuid(data?.user_id)) {
          throw new Error("turnstile returned invalid ids");
        }

        activeSessionId = data.session_id;
        activeUserId = data.user_id;
        sessionStorage.setItem(SESSION_ID_STORAGE_KEY, activeSessionId);
        localStorage.setItem(USER_ID_STORAGE_KEY, activeUserId);
        return { sessionId: activeSessionId, userId: activeUserId };
      };

      const ensureIdentity = async () => {
        if (isUuid(activeSessionId) && isUuid(activeUserId)) {
          return { sessionId: activeSessionId, userId: activeUserId };
        }

        const storedSessionId = sessionStorage.getItem(SESSION_ID_STORAGE_KEY);
        const storedUserId = localStorage.getItem(USER_ID_STORAGE_KEY);
        if (isUuid(storedSessionId) && isUuid(storedUserId)) {
          activeSessionId = storedSessionId;
          activeUserId = storedUserId;
          return { sessionId: activeSessionId, userId: activeUserId };
        }

        return bootstrapIdentity();
      };

      const ensureTwitchEmbed = () => {
        if (!twitchPlayer) return;
        if (twitchPlayer.querySelector("iframe")) return;
        const host = window.location.hostname || "ianlrsn.com";
        const parents = host === "ianlrsn.com" ? ["ianlrsn.com"] : [host, "ianlrsn.com"];
        const parentParams = parents.map((parent) => `parent=${encodeURIComponent(parent)}`).join("&");
        const iframe = document.createElement("iframe");
        iframe.src = `https://player.twitch.tv/?channel=ianlrsn&${parentParams}&muted=true&autoplay=false`;
        iframe.title = "Ianlrsn Twitch live stream";
        iframe.allowFullscreen = true;
        iframe.loading = "lazy";
        iframe.setAttribute("scrolling", "no");
        twitchPlayer.appendChild(iframe);
      };

      const clearTwitchEmbed = () => {
        if (!twitchPlayer) return;
        twitchPlayer.innerHTML = "";
      };

      const scheduleNextLiveCheck = (requestStartMs) => {
        if (liveCheckTimer) clearTimeout(liveCheckTimer);
        const targetTime =
          requestStartMs + CACHE_TTL_MS + (extraOffsetApplied ? extraOffsetMs : 0);
        const delay = Math.max(0, Math.round(targetTime - Date.now()));
        liveCheckTimer = setTimeout(checkTwitchLive, delay);
      };

      const checkTwitchLive = async () => {
        if (!twitchRow) return;
        const requestStartMs = Date.now();
        if (testLive) {
          twitchRow.classList.add("is-live");
          ensureTwitchEmbed();
          startCycle();
          scheduleNextLiveCheck(requestStartMs);
          return;
        }
        try {
          let identity = await ensureIdentity();
          let response = await fetch("/api/twitch-live", {
            cache: "no-store",
            headers: {
              "x-session-id": identity.sessionId,
              "x-user-id": identity.userId,
            },
          });

          if (response.status === 401) {
            clearSessionId();
            identity = await ensureIdentity();
            response = await fetch("/api/twitch-live", {
              cache: "no-store",
              headers: {
                "x-session-id": identity.sessionId,
                "x-user-id": identity.userId,
              },
            });
          }

          if (!response.ok) throw new Error("status fetch failed");
          const data = await response.json();
          const isLive = Boolean(data?.live);
          const cacheAgeMs = Number.isFinite(data?.cache_age_ms)
            ? data.cache_age_ms
            : (() => {
                const checkedAt = Date.parse(data?.checked_at);
                return Number.isNaN(checkedAt) ? undefined : Date.now() - checkedAt;
              })();
          if (
            !extraOffsetApplied &&
            data?.cache_status === "hit" &&
            Number.isFinite(cacheAgeMs) &&
            cacheAgeMs < EARLY_CACHE_THRESHOLD_MS
          ) {
            extraOffsetMs =
              EXTRA_OFFSET_MIN_MS +
              Math.floor(
                Math.random() * (EXTRA_OFFSET_MAX_MS - EXTRA_OFFSET_MIN_MS + 1)
              );
            extraOffsetApplied = true;
          }
          twitchRow.classList.toggle("is-live", isLive);
          if (isLive) {
            ensureTwitchEmbed();
            startCycle();
          } else {
            clearTwitchEmbed();
            stopCycle();
          }
          scheduleNextLiveCheck(requestStartMs);
        } catch (error) {
          twitchRow.classList.remove("is-live");
          clearTwitchEmbed();
          stopCycle();
          scheduleNextLiveCheck(requestStartMs);
        }
      };

      stopCycle();
      checkTwitchLive();
    </script>

  </body>
</html>
